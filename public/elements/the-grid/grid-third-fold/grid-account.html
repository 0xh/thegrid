<dom-module id="grid-account">
	<style include="iron-flex grid">
		:root {
			--paper-toolbar-background: #FFFFFF;
			--paper-toolbar-color: #636b6f;
		}
		:host {
			height: 100%;
		}
		.main-price {
			font-weight: 400;
			font-size: 18px;
		}
    #edit {
      position: absolute;
      right: 16px;
      bottom: 22px;
		}
    #editAccountModal {
      min-width: 400px;
      max-width: 100%;
    }
	</style>
	<template>
		<paper-scroll-header-panel class="flex h100">
			<paper-toolbar slot="header" class="border-bottom">
        <paper-icon-button icon="first-page" on-tap="closeParent"></paper-icon-button>
        <paper-icon-button icon="chevron-left" on-tap="close"></paper-icon-button>
        <div class="flex">Account</div>
			</paper-toolbar>
			<div class="relative h100">
        <paper-item>
					<paper-item-body two-line>
						<div>[[ _evaluate(user.name) ]]</div>
						<div secondary>Display Name</div>
					</paper-item-body>
				</paper-item>
        <paper-item>
					<paper-item-body two-line>
						<div>[[ _evaluate(user.profile.first_name) ]]</div>
						<div secondary>First Name</div>
					</paper-item-body>
				</paper-item>
        <paper-item>
					<paper-item-body two-line>
						<div>[[ _evaluate(user.profile.middle_name) ]]</div>
						<div secondary>Middle Name</div>
					</paper-item-body>
				</paper-item>
        <paper-item>
					<paper-item-body two-line>
						<div>[[ _evaluate(user.profile.last_name) ]]</div>
						<div secondary>Last Name</div>
					</paper-item-body>
				</paper-item>
        <paper-item>
					<paper-item-body two-line>
						<div>[[ _evaluate(user.profile.birth_date) ]]</div>
						<div secondary>Date of Birth</div>
					</paper-item-body>
				</paper-item>
        <!-- <paper-item>
					<paper-item-body two-line>
						<div>[[ _evaluate(user.profile.phone_number) ]]</div>
						<div secondary>Phone Number</div>
					</paper-item-body>
				</paper-item> -->
        <paper-item>
					<paper-item-body two-line>
						<div>[[ _evaluate(user.profile.address) ]]</div>
						<div secondary>Address</div>
					</paper-item-body>
				</paper-item>
        <paper-fab icon="create" id="edit" class="grid-main-fab" on-tap="openEditModal"></paper-fab>
			</div>
		</paper-scroll-header-panel>
    <paper-dialog id="editAccountModal" no-cancel-on-outside-click no-cancel-on-esc-key>
      <h2>Edit Account Details</h2>
      <div>
        <paper-input label="First Name" value="{{tmpUser.profile.first_name}}"></paper-input>
        <paper-input label="Middle Name" value="{{tmpUser.profile.middle_name}}"></paper-input>
        <paper-input label="Last Name" value="{{tmpUser.profile.last_name}}"></paper-input>
        <paper-input label="Date of Birth" value="{{tmpUser.profile.birth_date}}" on-focus="openDatePickerDialog"></paper-input>
        <!-- <paper-input label="Phone Number" value="{{tmpUser.profile.phone_number}}"></paper-input> -->
        <paper-input label="Address" value="{{tmpUser.profile.address}}"></paper-input>
      </div>
      <div class="buttons">
        <paper-button dialog-dismiss on-tap="cancel">Cancel</paper-button>
        <paper-button dialog-confirm autofocus on-tap="updateAccountDetails">Update</paper-button>
      </div>
    </paper-dialog>
    <app-datepicker-dialog id="datepicker"
      theme="goog-theme"
      format="mm/dd/yyyy"
      date="{{birthDate}}"
      view="vertical"
      disable-days="[7]"
      ></app-datepicker-dialog>
      <div hidden$="[[!isLoading]]" class="spinner-container">
  			<paper-spinner active$="[[isLoading]]"></paper-spinner>
  		</div>
	</template>
	<script>
		Polymer({
			is: 'grid-account',
			properties: {
				isLoading: {
					type: Boolean,
					value: false
				},
        user: {
          type: Object,
          value: function() {
            return Grid.user
          }
        },
        tmpUser: {
          type: Object,
          value: function() {
            return {};
          }
        },
        birthDate: {
          type: String,
          observer: '_birthDateChanged'
        }
			},
			behaviors: [
			GridBehaviors.FoldBehavior
			],
      _birthDateChanged: function(o, n) {
        this.set('tmpUser.profile.birth_date', this.birthDate);
      },
      _formatDate: function(date) {
        if( date ) {
          var d = new Data(date);
          return d.toLocaleDateString();
        }
        return date;
      },
      _evaluate: function(value) {
        if( value == 'undefined' || !value ) {
          return "Not set";
        }
        return value;
      },
      openEditModal: function() {
        for(var i in this.user) {
          this.set('tmpUser.' + i, this.user[i]);
        }
        for(var i in this.user.profile) {
          this.set('tmpUser.profile.' + i, this.user.profile[i]);
        }
        this.$.editAccountModal.open();
      },
      updateAccountDetails: function() {
        var self = this;
        self.isLoading = true;
        axios.put('/users/' + Grid.user.id, this.tmpUser)
        .then(function(response) {
          self.isLoading = false;
          var data = response.data;
          console.log(response.data);
          //for(var i in this.tmpUser.profile) {
            self.set('user.profile', data);
          //}
        })
        .catch(function(response) {
          self.isLoading = false;
        });
      },
      openDatePickerDialog: function() {
        this.$.datepicker.open();
      },
      cancel: function() {
        //this.set('user',this.tmpUser);
      },
			close: function() {
				this.thirdFold.close();
			},
      closeParent: function() {
				this.secondFold.close();
			},
			ready: function() {
        this.$.editAccountModal.fitInto = this;
        this.$.datepicker.fitInto = this;
			}
		});
	</script>
</dom-module>
